//use alloy_primitives::B256;
//use alloy_trie::HashBuilder;
//
//use crate::error::EthereumIBCError;
//
//pub fn validate_merkle_branch(
//    leaf: B256,
//    branch: Vec<B256>,
//    depth: usize,
//    index: usize,
//    root: B256,
//) -> Result<(), EthereumIBCError> {
//    let hash_builder = HashBuilder::default();
//
//    for branch_node in branch {
//        //hash_builder.add_branch(key, value, stored_in_database);
//    }
//
//    Ok(())
//}

use alloy_primitives::B256;
use ssz::ssz_encode;
use tree_hash::{merkle_root, merkleize_standard};

use crate::{
    client_state::{ClientState, ForkParameters},
    header::{compute_epoch_at_slot, LightClientHeader},
};

pub fn get_lc_execution_root(
    client_state: ClientState,
    fork_parameters: &ForkParameters,
    header: &LightClientHeader,
) -> B256 {
    let epoch = compute_epoch_at_slot(client_state.slots_per_epoch, header.beacon.slot);
    if epoch >= fork_parameters.deneb.epoch {
        //let v3_execution = header.execution.as_v3().unwrap();
        //let ssz_encoded = ssz_encode(&v3_execution);
        //return merkleize_standard(&ssz_encoded);
        //return header.execution.tree_hash_root().into();
    }

    //if epoch >= fork_parameters.capella.epoch {
    //    return CapellaExecutionPayloadHeader::from(header.execution.clone())
    //        .tree_hash_root()
    //        .into();
    //}

    B256::default()
}

// https://github.com/ethereum/consensus-specs/blob/efb554f4c4848f8bfc260fcf3ff4b806971716f6/specs/phase0/beacon-chain.md#is_valid_merkle_branch
pub fn is_valid_merkle_branch() {}

#[cfg(test)]
mod test {

    use alloy_primitives::{hex::FromHex, Address, Bloom, Bytes, B256, U256};
    use sha2::{Digest, Sha256};
    use tree_hash::TreeHash;

    use crate::{
        config::consts::{floorlog2, get_subtree_index, EXECUTION_PAYLOAD_INDEX},
        header::{
            BeaconBlockHeader, ExecutionPayloadHeader, LightClientHeader, MyBloom, MyBytes,
            MyExecutionPayloadBranch,
        },
    };

    /*
    Test output recv packet on cosmos
    Path: 30372d74656e6465726d696e742d30010000000000000001
    Storage root: d29e7a6bf6f70ffadbfccd0eb1c8d105e6ed4ffecbfa13b7e81a440927875b67
    Client state ibc commitement slot: 0000000000000000000000000000000000000000000000000000000000000001
    eth_getProof response: {StorageHash:0xd29e7a6bf6f70ffadbfccd0eb1c8d105e6ed4ffecbfa13b7e81a440927875b67 StorageProof:[{Key:0x75d7411cb01daad167713b5a9b7219670f0e500653cbbcd45cfe1bfe04222459 Proof:[0xf8718080a063ad7d58950cc376851796dee990d65f2528032efda8f1ac18dc9ec266ed6773a0271c986639c46d4a4ba0c6540274a7f642127b802d06476a036c113a030cb0218080a057b16d9a3bbb2d106b4d1b12dca3504f61899c7c660b036848511426ed342dd680808080808080808080 0xf843a03d3c3bcf030006afea2a677a6ff5bf3f7f111e87461c8848cf062a5756d1a888a1a07e453606e6e5573f93bcd118e653053a39039c87663a4509bcc2cd96415c907a] Value:0x7e453606e6e5573f93bcd118e653053a39039c87663a4509bcc2cd96415c907a}] AccountProof:[0xf90211a04aaf9d7810484eae30bd7e8dab383d5175b62228db610500a8bff4d1e77571a8a006d47616df479b46b302f2a8b7ed03cb537f6cf7c551c15421c65db4e00fa97fa0e633ef359bb4be85132d28a4ed3289e95d12015401cbfdbc512ab565cce4c224a0db620afa7f791e8a4993ed99a52560ac2b2ab5e32733bbd39981f4f4435c4824a0817094748d6653ef01a1dd7458d4171855f7d6c27cd631cbfebb01cf2d2e7332a01ad749d16dfe34c5232ce7887332ab4b35fea4be9989c8066b4c35337873c6c4a05860110a4c6a7347de239545dc6943ce5bc93304a9ec84a040f36fd22bf0b57ba083c6979e463c02818ffeadaeeb8abc9f2f51e767fb9151a7fc89989eb40b57aca06dd127bfed05255c99a9a412484f64f04c0e71e84fd97bfe12e321d41c2efe2ba0e543a1b8559c107a0abf31c13362687576179808811952a109d1139be145a9cca018e0f191e57d4186717e0f3c9379d2438cec0babd12d3903a4ad560f017331bfa07c888df7c015d6a90b4bbc9987fa7b55b0279c73745bda6a94c10e14fb0538eca0ad0bb86b47186c04223e85a9c33dd1c87dd6e5c17f753f4fd0a56772d8a78399a0899f71abb18c6c956118bf567fac629b75f7e9526873e429d3d8abb6dbb58021a04fe6521e02773adb4fdefcbfbc25a19b5127806e93e202ab08b3aad72c8be097a037ff00fbe2105bce0e6ed9ea80a1d67b8a476b1ff3d177ac9597a53241e47aa780 0xf90151a06664dd6bcbb08b83f84324db8cbaf2ceb221e49e66971369dd2257e947a3b13d80a0f4ec365c37413b5f9e7d38c3c6409922fa2a593757ef6176b7291ede5ae2b2d780a0614ab7fe84bea831a68e5e39c6e2d339db432b94dcd29ac75de694cfc6641496a0cb8cb51bd3f920a7b456096b69447564a8d9e5385c85016e15f5ce648dd1150aa0de6884336a2be8a68717b86e2c3a68af17fd54009336cc41386da3d03a8711fd80a0044dadb95a10fad8f922e38449d128807ed6c4b3e6af52d0faa865be8cb8847480a0d53e862eebd81f90452eada8434dfdd03a7ef3d06d6db3e68cbc7d05dff81ec0a0eb47388255e7ca68b42fa56180019c61e2dd301bfe20226d6a74d795f6b016a6a045dae89071470c6d8a04d06b0fd42ae48c47d174bea5cfb281e0efeb3ffbe18ba06c457c05a87c557f84f6d98cfb3754a20c1ded0550ef405433d3514f332c77df808080 0xf869a02003f8789e4b60f5e068dd0f322c2e61f95cb83ca6f9c67f90fe7544eabd3b9db846f8440180a0d29e7a6bf6f70ffadbfccd0eb1c8d105e6ed4ffecbfa13b7e81a440927875b67a0dc315430e913c2f86f8777f97771c90e6c93e6ccbc4900bc5166c0dead6493b2]}
    Test output
    Key: 0x75d7411cb01daad167713b5a9b7219670f0e500653cbbcd45cfe1bfe04222459
    Value: 0x7e453606e6e5573f93bcd118e653053a39039c87663a4509bcc2cd96415c907a
    Proof[0]: 0xf8718080a063ad7d58950cc376851796dee990d65f2528032efda8f1ac18dc9ec266ed6773a0271c986639c46d4a4ba0c6540274a7f642127b802d06476a036c113a030cb0218080a057b16d9a3bbb2d106b4d1b12dca3504f61899c7c660b036848511426ed342dd680808080808080808080
    Proof[1]: 0xf843a03d3c3bcf030006afea2a677a6ff5bf3f7f111e87461c8848cf062a5756d1a888a1a07e453606e6e5573f93bcd118e653053a39039c87663a4509bcc2cd96415c907a
    */
    #[test]
    fn test_validate_merkle_branch_with_storage_proof() {
        // we are going to use an example from a eth_getProof response where
        // the leaf is storage proof value
        // the branch is the proof array
        // the depth is ???
        // the index is the index of the leaf in the proof array
        // the root is the storage root

        //let storage_key =
        //    B256::from_hex("75d7411cb01daad167713b5a9b7219670f0e500653cbbcd45cfe1bfe04222459")
        //        .unwrap();
        //let key_hash = keccak256(storage_key);
        //let key_nibbles = Nibbles::unpack(key_hash);

        //let leaf =
        //    B256::from_hex("0x7e453606e6e5573f93bcd118e653053a39039c87663a4509bcc2cd96415c907a").unwrap();
        //let branch = vec![
        //    Bytes::from_hex("0xf8718080a063ad7d58950cc376851796dee990d65f2528032efda8f1ac18dc9ec266ed6773a0271c986639c46d4a4ba0c6540274a7f642127b802d06476a036c113a030cb0218080a057b16d9a3bbb2d106b4d1b12dca3504f61899c7c660b036848511426ed342dd680808080808080808080").unwrap(),
        //    Bytes::from_hex("0xf843a03d3c3bcf030006afea2a677a6ff5bf3f7f111e87461c8848cf062a5756d1a888a1a07e453606e6e5573f93bcd118e653053a39039c87663a4509bcc2cd96415c907a").unwrap(),
        //];
        //let depth = 3; // TODO: ???
        //let index = 0; // TODO: ???
        //let root =
        //    B256::from_hex("0xd29e7a6bf6f70ffadbfccd0eb1c8d105e6ed4ffecbfa13b7e81a440927875b67").unwrap();
        //

        /*
        * value = leaf
            for i in range(depth):
                if index // (2**i) % 2:
                    value = hash(branch[i] + value)
                else:
                    value = hash(value + branch[i])
            return value == root
        */

        /*
         {"data":{"attested_header":{"beacon":{"slot":"80","proposer_index":"39","parent_root":"0xb36d63dbbb78f2585ba3e2a3cdadbbbb7d2bab9e8f663053dbd93fdcecf24c1d","state_root":"0xfe12325f788e0e78434f8f3fa4970b970531d8209861ce52ea8a0fe2bdb5f252","body_root":"0x045a26b541713c820616774b2082317cdd74dcff424c255c803e558843e55371"},"execution":{"parent_hash":"0xf55156c2b27326547193bcd2501c8300a0f3617a7d71f096fc992955f042ea50","fee_recipient":"0x8943545177806ED17B9F23F0a21ee5948eCaa776","state_root":"0x47baba45d0ee0f0abaa42d7fbdba87908052d81fe33806576215bcf136167510","receipts_root":"0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421","logs_bloom":"0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","prev_randao":"0x707a729f27185bfd88c746532e0909f7f4604dc5b25b6d9ffb5cfec6ca7987d9","block_number":"80","gas_limit":"30000000","gas_used":"0","timestamp":"1732901097","extra_data":"0xd883010e06846765746888676f312e32322e34856c696e7578","base_fee_per_gas":"27136","block_hash":"0xc001e15851608006eb33999e829bb265706929091f4c9a08f6853f6fbe96a730","transactions_root":"0x7ffe241ea60187fdb0187bfa22de35d1f9bed7ab061d9401fd47e34a54fbede1","withdrawals_root":"0x28ba1834a3a7b657460ce79fa3a1d909ab8828fd557659d4d0554a9bdbc0ec30","blob_gas_used":"0","excess_blob_gas":"0"},"execution_branch":["0xd320d2b395e1065b0b2e3dbb7843c6d77cb7830ef340ffc968caa0f92e26f080","0x6c6dd63656639d153a2e86a9cab291e7a26e957ad635fec872d2836e92340c23","0xdb56114e00fdd4c1f85c892bf35ac9a89289aaecb1ebd0a96cde606a748b5d71","0xee70868f724f428f301007b0967c82d9c31fb5fd549d7f25342605169b90a3d6"]},"next_sync_committee":{"pubkeys":["0x9918433b8f0bc5e126da3fdef8d7b71456492dae6d2d07f2e10c7a7f852046f84ed0ce6d3bfec42200670db27dcf3037","0xaaf6c1251e73fb600624937760fef218aace5b253bf068ed45398aeb29d821e4d2899343ddcbbe37cb3f6cf500dff26c","0x81ea9f74ef7d935b807474e38954ae3934856219a23e074954b2e860c5a3c400f9aedb42cd27cb4ceb697ca36d1e58cb","0x8aec5129a518010912215e1887191da94be419b4e75904c2ea745e2d253d707c088fa5b2c46dade1d162affe9f7ab17b","0xa03c2a82374e04b2e0594c4ce14fb3f225b46f13188f0d8002a523c7dcfb939ae4856053c2c9c695374d7c3685df1ca5","0xa804e4fa8d1391a9d078aa93985a12503b84ce4f6f1f9e70ab7fca421e1cf972538666299d4c1bfc39327b469b2db7a8","0xb09cb155daf2022afd18114a352e506a84065c80573cb0c7c310cbe92e2706cdcf91f74bbd9e464f74e3d831386d5033","0x8dfa86c051edd28c3554a30e40531c898e5936ad3002711616ddd1b27054bc39caedd505a200c3d23a1c3f6b26c50ae9","0xa35c6004f387430c3797ab0157af7b824c8fe106241c7cdeb897d900c0f9e4bb945ff2a6b88cbd10e35ec48aaa554ecb","0xb2225575d5e70da1257db7a0d1222c5041b52aac61cf161e8fc8126a3fdf5eb4f0867d98dfe272199c36cf8f02661b3d","0x8d028a021c5c31a1aa1e18eda74cfaf0fba1c454c17c2e0fc730dd07a19d0c77f7a905d54017292f3e800ca06b6977cd","0x8419cf00f2783c430dc861a710984d0429d3b3a7f6db849b4f5c05e0d87339704c5c7f5eede6adfc8776d666587b5932","0xabd12678c73463ecea5867a80caf256d5c5e6ba53ff188b143a4d5be83365ad257edf39eaa1ba8753c4cdf4c632ff99e","0x8de5a6200cebb09b2198e69fed84bcd512ec5cf317c5f1ee99aad03d2a9a8564bf3807c08da2664222268d59c34a06e4","0xb27ad13afc8ff30e087797b344c8382bb0a84447549f1b0274059ddd652276e7b148ba8808a10cc45746762957d4efbe","0xa75ca9447dca3a3745ada36731187ddd1f6a152cf15d7446b785eab381e5c8562c1202a6e7a24080bc6b619a161113db","0xac69ae9e6c385a368df71d11ac68f45f05e005306df3c2bf98ed3577708256bd97f8c09d3f72115444077a9bb711d8d1","0x930743bfc7e18d3bd7351eaa74f477505268c1e4e1fd1ca3ccccdefb2595517343bbb8f5589c435c3c39323a4c0080f8","0xa0485d71f1f5e177f7d5bc9d98c5248a6a2d0de4554c2eaf02abae48f5a3e273b2ee7765784cf2a4cb7df84f617177c9","0xaf89ab00a0eab1131645292a9cfba583a69a1e3ac58b210e262494853e67385aeb50d4af428bdd577b9399daa96d8b20","0x99d83a0ba33161d8c6bbe80929fd9046d4dfdac43477ff85fea5bae925e6c179ad28eb338375ee2417acbd6576ee670a","0x8c0d15baa72bfcd317e9b9402ca9bb6e7ae1db35ffce7faccae0bd19b3c8e5de7d5524aef0377770b3a90626627a9304","0xa62c0205fb22df8535c0b70076486e69dfa908feddae79e4a94a9d47b97ed190d228e1c6217e84a59882bb992dacae30","0xb570dde8ee80512e3d031caf22e775c60f7f5a6cbdeb3e52e24cf8c867d38569a53dd19cdc36a03a1bbb3a8d94b03670","0xb24391aa97bfff29adc935d06a2b6d583433caf82f92de1980e0192d3b270323bdbf24b86dc61520a40c419dde3df4b3","0xab64f900c770e2b99de6b86b4390bbd1579bd48dccec55800adbcf52e006f22128e9971bbf3a92cc0105b0974849935a","0x84d08d58c31bcd3cddf93e13d6f50203897384afa34644bff1135efe8e01c81c6a91ca6c234bb1e51ca32e41b828aaf9","0xae5302796cfeca685eaf37ffd5baeb32121f2f07415bee26cc0051ee513ff3932d2c365e3d9f87b0949a5980445cb64c","0x896a51e0b0de0f29029af38b796db1f1e6d0f9f9085ade40a313a60cb723fa3d58f6587175570086c4fbf0fe5331f1c8","0xab72cbc6575c3179680a58c0ecd5de46d2678ccbafc016746348ee5688edcb21b4e15bd37c70c508e3ea73103c2d566b","0xab40dc1cfe273ad0da700c64f8fc94f91db253ca3acf20e336d9bd09de67eec5c7d3506285d83c7bb6a08d64b77e5f2d","0xa1d9840eda3036fbf63eeea40146e4548553e6e1b2a653ab349b376f31b367c40d71fb59ff8e94b91daa99c262ec8b52"],"aggregate_pubkey":"0xa4528aa2f0f3d8f9d4dcc2858bd4f7072f8a8f5e8e147ae70bb98d871546de187dfef4659825106c3fe1389a642f93a6"},"next_sync_committee_branch":["0x6852747e40e9736bac9dfbec4d866bb5221dbffa06a3e8770dd4ad45b4920e47","0x5a95857db59bb41fe3a29b5aaf7f63e7e5a1d16d18440b748c02d02e72edf33d","0xf624a21518c8ad428de321debb72e6e87ec6e9e66c63b3549e0ac683ff13bfa4","0xac612621e1483939533a431bcf8a68f767e435eddc7ebc46d4044b223de2e31b","0x079eef86bbdad671b910792bbac92665ac22221b453621db69cb1ab03b330afe"],"finalized_header":{"beacon":{"slot":"64","proposer_index":"5","parent_root":"0xe14642f0baa7bd240fd7b56e77e6e2d8e8aad0114229cbe5f5ea03c198df9c93","state_root":"0x00443c2479ac6b9309a40488e9e258bcad9b39290883fc6d30a425afd17c3699","body_root":"0x204c2fe416069636c529e15c6f223a0bf3093718f8d276b87f7f9f00d91b956d"},"execution":{"parent_hash":"0xe3fd84c193ae3a66bab7cfb537d09ba94f61bfa67dd6bf3ddd260c8ffa719a7b","fee_recipient":"0x8943545177806ED17B9F23F0a21ee5948eCaa776","state_root":"0xaca31c862bc1a7437b8badbf79f506b8052269e6ae122f8adba67205ee67b6b7","receipts_root":"0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421","logs_bloom":"0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","prev_randao":"0x819c986794b83cbe3c0d7adccfb80bb7ff0be5001a0d56ebf9617b51bfdbdd6c","block_number":"64","gas_limit":"30000000","gas_used":"0","timestamp":"1732901001","extra_data":"0xd883010e06846765746888676f312e32322e34856c696e7578","base_fee_per_gas":"229809","block_hash":"0xee52360e7f7581300baae7406d48374318d5078552785e3e62b4386bfea14464","transactions_root":"0x7ffe241ea60187fdb0187bfa22de35d1f9bed7ab061d9401fd47e34a54fbede1","withdrawals_root":"0x28ba1834a3a7b657460ce79fa3a1d909ab8828fd557659d4d0554a9bdbc0ec30","blob_gas_used":"0","excess_blob_gas":"0"},"execution_branch":["0x68afcc188acc909b93ad6083997700b693b5e98bfda44df124d4c88219b6b787","0x6c6dd63656639d153a2e86a9cab291e7a26e957ad635fec872d2836e92340c23","0xdb56114e00fdd4c1f85c892bf35ac9a89289aaecb1ebd0a96cde606a748b5d71","0x24d2a4659cd9e7f88d7a44eee17b8518cf8007f756b4cb8575932a02b93cf3cd"]},"finality_branch":["0x0800000000000000000000000000000000000000000000000000000000000000","0x5f6f02af29218292d21a69b64a794a7c0873b3e0f54611972863706e8cbdf371","0x9767f31a1964e34e4d014a9e726670d10f35c3115739c30ba08e5ff8e558405a","0xf624a21518c8ad428de321debb72e6e87ec6e9e66c63b3549e0ac683ff13bfa4","0xac612621e1483939533a431bcf8a68f767e435eddc7ebc46d4044b223de2e31b","0x079eef86bbdad671b910792bbac92665ac22221b453621db69cb1ab03b330afe"],"sync_aggregate":{"sync_committee_bits":"0xffffffff","sync_committee_signature":"0x8b1e04a1ec3a193a9fc0ae820fa3ce992be48cfc706797888a5c65d3092896a8c340fcd35c47756c9fb64912259fbb5a02c84b5b73ec7ff61bc19f2adce84fcd819d294bae527da2a54c6f493dfc99a7ee249faabe8d58f22f4cb5f7a24775d0"},"signature_slot":"81"}}
        */

        let header = LightClientHeader {
            beacon: BeaconBlockHeader {
                slot: 10000,
                proposer_index: 0,
                parent_root: B256::default(),
                state_root: B256::default(),
                body_root: B256::from_hex(
                    "0x045a26b541713c820616774b2082317cdd74dcff424c255c803e558843e55371",
                )
                .unwrap(),
            },
            execution: ExecutionPayloadHeader {
                parent_hash: B256::from_hex(
                    "f55156c2b27326547193bcd2501c8300a0f3617a7d71f096fc992955f042ea50",
                )
                .unwrap(),
                fee_recipient: Address::from_hex("0x8943545177806ED17B9F23F0a21ee5948eCaa776").unwrap(),
                state_root: B256::from_hex(
                    "47baba45d0ee0f0abaa42d7fbdba87908052d81fe33806576215bcf136167510",
                )
                .unwrap(),
                receipts_root: B256::from_hex(
                    "56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421",
                ).unwrap(),
                logs_bloom: MyBloom(Bloom::from_hex("0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000").unwrap()),
                prev_randao: B256::from_hex("707a729f27185bfd88c746532e0909f7f4604dc5b25b6d9ffb5cfec6ca7987d9").unwrap(),
                block_number: 80,
                gas_limit: 30000000,
                gas_used: 0,
                timestamp: 1732901097,
                extra_data: MyBytes(Bytes::from_hex("0xd883010e06846765746888676f312e32322e34856c696e7578").unwrap()),
                base_fee_per_gas: U256::from(27136),
                block_hash: B256::from_hex("c001e15851608006eb33999e829bb265706929091f4c9a08f6853f6fbe96a730").unwrap(),
                transactions_root: B256::from_hex("0x7ffe241ea60187fdb0187bfa22de35d1f9bed7ab061d9401fd47e34a54fbede1").unwrap(),
                withdrawals_root: B256::from_hex("0x28ba1834a3a7b657460ce79fa3a1d909ab8828fd557659d4d0554a9bdbc0ec30").unwrap(),
                blob_gas_used: 0,
                excess_blob_gas: 0,
            },
            execution_branch: MyExecutionPayloadBranch([
                B256::from_hex("0xd320d2b395e1065b0b2e3dbb7843c6d77cb7830ef340ffc968caa0f92e26f080")
                    .unwrap(),
                B256::from_hex("0x6c6dd63656639d153a2e86a9cab291e7a26e957ad635fec872d2836e92340c23")
                    .unwrap(),
                B256::from_hex("0xdb56114e00fdd4c1f85c892bf35ac9a89289aaecb1ebd0a96cde606a748b5d71")
                    .unwrap(),
                B256::from_hex("0xee70868f724f428f301007b0967c82d9c31fb5fd549d7f25342605169b90a3d6")
                    .unwrap(),
            ]),
        };
        //let ssz_encoded = ssz_encode(&execution_payload_header);
        //let execution_root = merkleize_standard(&ssz_encoded);

        // inputs
        //let mut leaf = execution_root;
        let depth = floorlog2(EXECUTION_PAYLOAD_INDEX);
        let index = get_subtree_index(EXECUTION_PAYLOAD_INDEX);
        let root = header.beacon.body_root;

        //let mut hasher =
        //    MerkleHasher::with_leaves((ssz_encoded.len() + BYTES_PER_CHUNK - 1) / BYTES_PER_CHUNK);
        //for item in &ssz_encoded {
        //    hasher.write(item.tree_hash_root().as_ref()).unwrap()
        //}
        //let intermediate_hash = hasher.finish().unwrap();
        //let alternative_tree_hash_root = tree_hash::mix_in_length(&root, ssz_encoded.len());
        //
        //println!("intermediate_hash: {:?}", intermediate_hash);
        //println!(
        //    "alternative_tree_hash_root: {:?}",
        //    alternative_tree_hash_root
        //);
        //leaf = alternative_tree_hash_root;

        let leaf = header.execution.tree_hash_root();

        println!("Leafi {:?}", leaf);
        println!("Branch: {:?}", header.execution_branch);
        println!("Depth: {:?}", depth);
        println!("Index: {:?}", index);
        println!("Root: {:?}", root);

        let mut value = leaf;
        for (i, branch_node) in header.execution_branch.0.iter().take(depth).enumerate() {
            if (index / 2u64.checked_pow(i as u32).unwrap()) % 2 != 0 {
                let mut hasher = Sha256::new();
                hasher.update(branch_node);
                hasher.update(value);

                value = B256::from_slice(&hasher.finalize()[..]);
            } else {
                let mut hasher = Sha256::new();
                hasher.update(value);
                hasher.update(branch_node);

                value = B256::from_slice(&hasher.finalize()[..]);
            }
        }

        println!("Value: {:?}", value);
        println!("Root: {:?}", root);

        //println!("Execution root: {:?}", execution_root);
        //println!("ssz bytes: {:?}", ssz_encoded);
        //println!("ssz bytes hex: {:?}", to_hex(&ssz_encoded));

        //let mut hash_builder = HashBuilder::default();
        //for branch_node in branch {
        //    let data: Vec<u8> = branch_node.into();
        //    let trie_node = TrieNode::decode(&mut &data[..]).unwrap();
        //
        //    match trie_node {
        //        TrieNode::Branch(branch_node) => {
        //            println!("Branch node: {:?}", branch_node);
        //            for (i, child) in branch_node.as_ref().indexed_children() {
        //                println!("hash_builder.key: {:?}", hash_builder.key);
        //                let nibble = Nibbles::from_nibbles(vec![i]);
        //                hash_builder.add_branch(nibble, child, false);
        //            }
        //        }
        //        TrieNode::Extension(_extension_node) => todo!(),
        //        TrieNode::Leaf(leaf_node) => {
        //            println!("hash_builder.key: {:?}", hash_builder.key);
        //            println!("Leaf node: {:?}", leaf_node);
        //            hash_builder.add_leaf(leaf_node.key, leaf_node.value.as_ref());
        //        }
        //    }
        //}
        //
        //hash_builder.print_stack();
        //let result = hash_builder.root();
        //println!("Result: {:?}", result);
    }
}

/*
Updating eth light client to at least block number 59 (with minimum requested: 58)
eth_getProof response: {StorageHash:0xed852b8b49686b782e0d3503371ab0093fd0de146c938e700075f85c15a271a2 StorageProof:[] AccountProof:[0xf90211a04aaf9d7810484eae30bd7e8dab383d5175b62228db610500a8bff4d1e77571a8a0e3390c27650b4fbb000832e6ee522473e7330b0cbb0b3a726d00ca790e6f1a3ea0e7ece161691233a2f5e4848c2030f2f5bca797bc83f2a2132b1b7caafc034ce9a0861e89558a62561a0c8e41f1a3d8ae8dce0c90988c65fad655a18fb00b714f28a0d0d580e2f8d638f6bfbae9ab29ad60a52d11bcf7081621fc9c1cd0decac17815a0d8df51c3eb58c4b935fc052af6606c62b523f609d9fec862c8831d0f25da5df0a05d61ef3ac1c641228a041a9515231e155e3f513c597438daae5b5aa64ebb2e67a083c6979e463c02818ffeadaeeb8abc9f2f51e767fb9151a7fc89989eb40b57aca07c363a6990bad4d8a3926c58559ff11819641586985425239167ac62d7c45caaa04c1a27dc79f668f96b1f2a4fb3dc6e55cd562e60e7a27bf4f007a08579b7b065a007fb4c1c9c7e0b7cb66ed207edcb88ae433e539ba1eee0b4c06a2de9d727e558a03f53262b95c47d6b63ccc0181ce819dcd659d1c09486cbc52c71e20401fa1e4ba05fd36b756781a8f362bd21fee22ff3c1ac7a09f57cc8f1e156706c311d024b63a0899f71abb18c6c956118bf567fac629b75f7e9526873e429d3d8abb6dbb58021a0962f0f7ccb43c78ba23f99be63d7fbefc9acafbb3be87270eb8d850e50906cffa098b281ba439bd07d87e9ecd48dc58a021a097012bb709306e0b0bf611b8ff2af80 0xf90171a05740575999fde2ddd421a9f5907dfc4be5fc3f5f96d65240ae3b3b596d38465f80808080a07ee878af944ffe26ce5c64042dcc79df748286de580e561107594449d8ed516fa0eb748aae6c0c30fc952f9caa1cd5753bc220e571fdd3eb87f90016b4ee1b0d38a08fbc48b46244cb31d89fefbb67b475551bf6e21c42e1f00516c0effe9f25eaa4a0ba3c3a2ecc624f3b5c6ea224bb6f80ad3b5c6cc65d17073b56a24169718a9910a05f4ca08c32e4a3997d0e94d8946e3d361ec5d0225d9cd85c6de8d572bb0a99c980a0faecf459527318d12fee2db8d85c54fc244d0207ba336a01e397593b801ae61fa0d9b3608f7e3498ffe810563f0c0925bea0287cdea57ea1f3ae29af45a192667fa0ca2e251e82502284289d0066710469330d9ec45890680a0909cf47f06c15855ea078dd0d51d6ac04896c6bcde86efc36c825a1e0e42d365e163180f3bc29b91de7a00844a6824efe874b61c480f88d1b0639780aa16aefbad5647403fc7ea6c274b280 0xf869a020d2ea7c26804b7e87d6da6a9e9aba30e4438dbc4bdc72c61b553f426431bf84b846f8440180a0ed852b8b49686b782e0d3503371ab0093fd0de146c938e700075f85c15a271a2a0dc315430e913c2f86f8777f97771c90e6c93e6ccbc4900bc5166c0dead6493b2]}
light client update: {"data":{"attested_header":{"beacon":{"slot":"80","proposer_index":"39","parent_root":"0xb36d63dbbb78f2585ba3e2a3cdadbbbb7d2bab9e8f663053dbd93fdcecf24c1d","state_root":"0xfe12325f788e0e78434f8f3fa4970b970531d8209861ce52ea8a0fe2bdb5f252","body_root":"0x045a26b541713c820616774b2082317cdd74dcff424c255c803e558843e55371"},"execution":{"parent_hash":"0xf55156c2b27326547193bcd2501c8300a0f3617a7d71f096fc992955f042ea50","fee_recipient":"0x8943545177806ED17B9F23F0a21ee5948eCaa776","state_root":"0x47baba45d0ee0f0abaa42d7fbdba87908052d81fe33806576215bcf136167510","receipts_root":"0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421","logs_bloom":"0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","prev_randao":"0x707a729f27185bfd88c746532e0909f7f4604dc5b25b6d9ffb5cfec6ca7987d9","block_number":"80","gas_limit":"30000000","gas_used":"0","timestamp":"1732901097","extra_data":"0xd883010e06846765746888676f312e32322e34856c696e7578","base_fee_per_gas":"27136","block_hash":"0xc001e15851608006eb33999e829bb265706929091f4c9a08f6853f6fbe96a730","transactions_root":"0x7ffe241ea60187fdb0187bfa22de35d1f9bed7ab061d9401fd47e34a54fbede1","withdrawals_root":"0x28ba1834a3a7b657460ce79fa3a1d909ab8828fd557659d4d0554a9bdbc0ec30","blob_gas_used":"0","excess_blob_gas":"0"},"execution_branch":["0xd320d2b395e1065b0b2e3dbb7843c6d77cb7830ef340ffc968caa0f92e26f080","0x6c6dd63656639d153a2e86a9cab291e7a26e957ad635fec872d2836e92340c23","0xdb56114e00fdd4c1f85c892bf35ac9a89289aaecb1ebd0a96cde606a748b5d71","0xee70868f724f428f301007b0967c82d9c31fb5fd549d7f25342605169b90a3d6"]},"next_sync_committee":{"pubkeys":["0x9918433b8f0bc5e126da3fdef8d7b71456492dae6d2d07f2e10c7a7f852046f84ed0ce6d3bfec42200670db27dcf3037","0xaaf6c1251e73fb600624937760fef218aace5b253bf068ed45398aeb29d821e4d2899343ddcbbe37cb3f6cf500dff26c","0x81ea9f74ef7d935b807474e38954ae3934856219a23e074954b2e860c5a3c400f9aedb42cd27cb4ceb697ca36d1e58cb","0x8aec5129a518010912215e1887191da94be419b4e75904c2ea745e2d253d707c088fa5b2c46dade1d162affe9f7ab17b","0xa03c2a82374e04b2e0594c4ce14fb3f225b46f13188f0d8002a523c7dcfb939ae4856053c2c9c695374d7c3685df1ca5","0xa804e4fa8d1391a9d078aa93985a12503b84ce4f6f1f9e70ab7fca421e1cf972538666299d4c1bfc39327b469b2db7a8","0xb09cb155daf2022afd18114a352e506a84065c80573cb0c7c310cbe92e2706cdcf91f74bbd9e464f74e3d831386d5033","0x8dfa86c051edd28c3554a30e40531c898e5936ad3002711616ddd1b27054bc39caedd505a200c3d23a1c3f6b26c50ae9","0xa35c6004f387430c3797ab0157af7b824c8fe106241c7cdeb897d900c0f9e4bb945ff2a6b88cbd10e35ec48aaa554ecb","0xb2225575d5e70da1257db7a0d1222c5041b52aac61cf161e8fc8126a3fdf5eb4f0867d98dfe272199c36cf8f02661b3d","0x8d028a021c5c31a1aa1e18eda74cfaf0fba1c454c17c2e0fc730dd07a19d0c77f7a905d54017292f3e800ca06b6977cd","0x8419cf00f2783c430dc861a710984d0429d3b3a7f6db849b4f5c05e0d87339704c5c7f5eede6adfc8776d666587b5932","0xabd12678c73463ecea5867a80caf256d5c5e6ba53ff188b143a4d5be83365ad257edf39eaa1ba8753c4cdf4c632ff99e","0x8de5a6200cebb09b2198e69fed84bcd512ec5cf317c5f1ee99aad03d2a9a8564bf3807c08da2664222268d59c34a06e4","0xb27ad13afc8ff30e087797b344c8382bb0a84447549f1b0274059ddd652276e7b148ba8808a10cc45746762957d4efbe","0xa75ca9447dca3a3745ada36731187ddd1f6a152cf15d7446b785eab381e5c8562c1202a6e7a24080bc6b619a161113db","0xac69ae9e6c385a368df71d11ac68f45f05e005306df3c2bf98ed3577708256bd97f8c09d3f72115444077a9bb711d8d1","0x930743bfc7e18d3bd7351eaa74f477505268c1e4e1fd1ca3ccccdefb2595517343bbb8f5589c435c3c39323a4c0080f8","0xa0485d71f1f5e177f7d5bc9d98c5248a6a2d0de4554c2eaf02abae48f5a3e273b2ee7765784cf2a4cb7df84f617177c9","0xaf89ab00a0eab1131645292a9cfba583a69a1e3ac58b210e262494853e67385aeb50d4af428bdd577b9399daa96d8b20","0x99d83a0ba33161d8c6bbe80929fd9046d4dfdac43477ff85fea5bae925e6c179ad28eb338375ee2417acbd6576ee670a","0x8c0d15baa72bfcd317e9b9402ca9bb6e7ae1db35ffce7faccae0bd19b3c8e5de7d5524aef0377770b3a90626627a9304","0xa62c0205fb22df8535c0b70076486e69dfa908feddae79e4a94a9d47b97ed190d228e1c6217e84a59882bb992dacae30","0xb570dde8ee80512e3d031caf22e775c60f7f5a6cbdeb3e52e24cf8c867d38569a53dd19cdc36a03a1bbb3a8d94b03670","0xb24391aa97bfff29adc935d06a2b6d583433caf82f92de1980e0192d3b270323bdbf24b86dc61520a40c419dde3df4b3","0xab64f900c770e2b99de6b86b4390bbd1579bd48dccec55800adbcf52e006f22128e9971bbf3a92cc0105b0974849935a","0x84d08d58c31bcd3cddf93e13d6f50203897384afa34644bff1135efe8e01c81c6a91ca6c234bb1e51ca32e41b828aaf9","0xae5302796cfeca685eaf37ffd5baeb32121f2f07415bee26cc0051ee513ff3932d2c365e3d9f87b0949a5980445cb64c","0x896a51e0b0de0f29029af38b796db1f1e6d0f9f9085ade40a313a60cb723fa3d58f6587175570086c4fbf0fe5331f1c8","0xab72cbc6575c3179680a58c0ecd5de46d2678ccbafc016746348ee5688edcb21b4e15bd37c70c508e3ea73103c2d566b","0xab40dc1cfe273ad0da700c64f8fc94f91db253ca3acf20e336d9bd09de67eec5c7d3506285d83c7bb6a08d64b77e5f2d","0xa1d9840eda3036fbf63eeea40146e4548553e6e1b2a653ab349b376f31b367c40d71fb59ff8e94b91daa99c262ec8b52"],"aggregate_pubkey":"0xa4528aa2f0f3d8f9d4dcc2858bd4f7072f8a8f5e8e147ae70bb98d871546de187dfef4659825106c3fe1389a642f93a6"},"next_sync_committee_branch":["0x6852747e40e9736bac9dfbec4d866bb5221dbffa06a3e8770dd4ad45b4920e47","0x5a95857db59bb41fe3a29b5aaf7f63e7e5a1d16d18440b748c02d02e72edf33d","0xf624a21518c8ad428de321debb72e6e87ec6e9e66c63b3549e0ac683ff13bfa4","0xac612621e1483939533a431bcf8a68f767e435eddc7ebc46d4044b223de2e31b","0x079eef86bbdad671b910792bbac92665ac22221b453621db69cb1ab03b330afe"],"finalized_header":{"beacon":{"slot":"64","proposer_index":"5","parent_root":"0xe14642f0baa7bd240fd7b56e77e6e2d8e8aad0114229cbe5f5ea03c198df9c93","state_root":"0x00443c2479ac6b9309a40488e9e258bcad9b39290883fc6d30a425afd17c3699","body_root":"0x204c2fe416069636c529e15c6f223a0bf3093718f8d276b87f7f9f00d91b956d"},"execution":{"parent_hash":"0xe3fd84c193ae3a66bab7cfb537d09ba94f61bfa67dd6bf3ddd260c8ffa719a7b","fee_recipient":"0x8943545177806ED17B9F23F0a21ee5948eCaa776","state_root":"0xaca31c862bc1a7437b8badbf79f506b8052269e6ae122f8adba67205ee67b6b7","receipts_root":"0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421","logs_bloom":"0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","prev_randao":"0x819c986794b83cbe3c0d7adccfb80bb7ff0be5001a0d56ebf9617b51bfdbdd6c","block_number":"64","gas_limit":"30000000","gas_used":"0","timestamp":"1732901001","extra_data":"0xd883010e06846765746888676f312e32322e34856c696e7578","base_fee_per_gas":"229809","block_hash":"0xee52360e7f7581300baae7406d48374318d5078552785e3e62b4386bfea14464","transactions_root":"0x7ffe241ea60187fdb0187bfa22de35d1f9bed7ab061d9401fd47e34a54fbede1","withdrawals_root":"0x28ba1834a3a7b657460ce79fa3a1d909ab8828fd557659d4d0554a9bdbc0ec30","blob_gas_used":"0","excess_blob_gas":"0"},"execution_branch":["0x68afcc188acc909b93ad6083997700b693b5e98bfda44df124d4c88219b6b787","0x6c6dd63656639d153a2e86a9cab291e7a26e957ad635fec872d2836e92340c23","0xdb56114e00fdd4c1f85c892bf35ac9a89289aaecb1ebd0a96cde606a748b5d71","0x24d2a4659cd9e7f88d7a44eee17b8518cf8007f756b4cb8575932a02b93cf3cd"]},"finality_branch":["0x0800000000000000000000000000000000000000000000000000000000000000","0x5f6f02af29218292d21a69b64a794a7c0873b3e0f54611972863706e8cbdf371","0x9767f31a1964e34e4d014a9e726670d10f35c3115739c30ba08e5ff8e558405a","0xf624a21518c8ad428de321debb72e6e87ec6e9e66c63b3549e0ac683ff13bfa4","0xac612621e1483939533a431bcf8a68f767e435eddc7ebc46d4044b223de2e31b","0x079eef86bbdad671b910792bbac92665ac22221b453621db69cb1ab03b330afe"],"sync_aggregate":{"sync_committee_bits":"0xffffffff","sync_committee_signature":"0x8b1e04a1ec3a193a9fc0ae820fa3ce992be48cfc706797888a5c65d3092896a8c340fcd35c47756c9fb64912259fbb5a02c84b5b73ec7ff61bc19f2adce84fcd819d294bae527da2a54c6f493dfc99a7ee249faabe8d58f22f4cb5f7a24775d0"},"signature_slot":"81"}}Adding new header: header height: 80, trusted height: 32, signature slot: 81, finalized slot: 64, finalized execution block: 64
Updating eth light client: header height: 80, trusted height: 32, signature slot: 81, finalized slot: 64, finalized execution block: 64
Updated eth light client to block number 80
Updated past target block number, skipping any further updates
Test output recv packet on cosmos
Path: 30372d74656e6465726d696e742d30010000000000000001
Storage root: ed852b8b49686b782e0d3503371ab0093fd0de146c938e700075f85c15a271a2
Client state ibc commitement slot: 0000000000000000000000000000000000000000000000000000000000000001
eth_getProof response: {StorageHash:0xed852b8b49686b782e0d3503371ab0093fd0de146c938e700075f85c15a271a2 StorageProof:[{Key:0x75d7411cb01daad167713b5a9b7219670f0e500653cbbcd45cfe1bfe04222459 Proof:[0xf8718080a02536b0f57bc80fdec6865ce363b9d0c308e3cd7a5bdce5e966c3a912c675a91da0ef0a11c090dac56b718f473860509b5b7f5983914a7f2a0d9b182dedc00cc5be8080a057b16d9a3bbb2d106b4d1b12dca3504f61899c7c660b036848511426ed342dd680808080808080808080 0xf843a03d3c3bcf030006afea2a677a6ff5bf3f7f111e87461c8848cf062a5756d1a888a1a0879562a6a42563c61cbd453a281492f1cf13663200f08122353186b2576fb4fd] Value:0x879562a6a42563c61cbd453a281492f1cf13663200f08122353186b2576fb4fd}] AccountProof:[0xf90211a04aaf9d7810484eae30bd7e8dab383d5175b62228db610500a8bff4d1e77571a8a0e3390c27650b4fbb000832e6ee522473e7330b0cbb0b3a726d00ca790e6f1a3ea0e7ece161691233a2f5e4848c2030f2f5bca797bc83f2a2132b1b7caafc034ce9a0861e89558a62561a0c8e41f1a3d8ae8dce0c90988c65fad655a18fb00b714f28a0d0d580e2f8d638f6bfbae9ab29ad60a52d11bcf7081621fc9c1cd0decac17815a0d8df51c3eb58c4b935fc052af6606c62b523f609d9fec862c8831d0f25da5df0a05d61ef3ac1c641228a041a9515231e155e3f513c597438daae5b5aa64ebb2e67a083c6979e463c02818ffeadaeeb8abc9f2f51e767fb9151a7fc89989eb40b57aca07c363a6990bad4d8a3926c58559ff11819641586985425239167ac62d7c45caaa04c1a27dc79f668f96b1f2a4fb3dc6e55cd562e60e7a27bf4f007a08579b7b065a007fb4c1c9c7e0b7cb66ed207edcb88ae433e539ba1eee0b4c06a2de9d727e558a03f53262b95c47d6b63ccc0181ce819dcd659d1c09486cbc52c71e20401fa1e4ba05fd36b756781a8f362bd21fee22ff3c1ac7a09f57cc8f1e156706c311d024b63a0899f71abb18c6c956118bf567fac629b75f7e9526873e429d3d8abb6dbb58021a0962f0f7ccb43c78ba23f99be63d7fbefc9acafbb3be87270eb8d850e50906cffa098b281ba439bd07d87e9ecd48dc58a021a097012bb709306e0b0bf611b8ff2af80 0xf90171a05740575999fde2ddd421a9f5907dfc4be5fc3f5f96d65240ae3b3b596d38465f80808080a07ee878af944ffe26ce5c64042dcc79df748286de580e561107594449d8ed516fa0eb748aae6c0c30fc952f9caa1cd5753bc220e571fdd3eb87f90016b4ee1b0d38a08fbc48b46244cb31d89fefbb67b475551bf6e21c42e1f00516c0effe9f25eaa4a0ba3c3a2ecc624f3b5c6ea224bb6f80ad3b5c6cc65d17073b56a24169718a9910a05f4ca08c32e4a3997d0e94d8946e3d361ec5d0225d9cd85c6de8d572bb0a99c980a0faecf459527318d12fee2db8d85c54fc244d0207ba336a01e397593b801ae61fa0d9b3608f7e3498ffe810563f0c0925bea0287cdea57ea1f3ae29af45a192667fa0ca2e251e82502284289d0066710469330d9ec45890680a0909cf47f06c15855ea078dd0d51d6ac04896c6bcde86efc36c825a1e0e42d365e163180f3bc29b91de7a00844a6824efe874b61c480f88d1b0639780aa16aefbad5647403fc7ea6c274b280 0xf869a020d2ea7c26804b7e87d6da6a9e9aba30e4438dbc4bdc72c61b553f426431bf84b846f8440180a0ed852b8b49686b782e0d3503371ab0093fd0de146c938e700075f85c15a271a2a0dc315430e913c2f86f8777f97771c90e6c93e6ccbc4900bc5166c0dead6493b2]}
Test output
Key: 0x75d7411cb01daad167713b5a9b7219670f0e500653cbbcd45cfe1bfe04222459
Value: 0x879562a6a42563c61cbd453a281492f1cf13663200f08122353186b2576fb4fd
Proof[0]: 0xf8718080a02536b0f57bc80fdec6865ce363b9d0c308e3cd7a5bdce5e966c3a912c675a91da0ef0a11c090dac56b718f473860509b5b7f5983914a7f2a0d9b182dedc00cc5be8080a057b16d9a3bbb2d106b4d1b12dca3504f61899c7c660b036848511426ed342dd680808080808080808080
Proof[1]: 0xf843a03d3c3bcf030006afea2a677a6ff5bf3f7f111e87461c8848cf062a5756d1a888a1a0879562a6a42563c61cbd453a281492f1cf13663200f08122353186b2576fb4fd
*/
